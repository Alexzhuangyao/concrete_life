# ä»»åŠ¡æ´¾å•æ¨¡å—æ–‡æ¡£

## ğŸ“¦ æ¨¡å—æ¦‚è¿°

ä»»åŠ¡æ´¾å•æ¨¡å—è´Ÿè´£ä»è®¢å•åˆ›å»ºé…é€ä»»åŠ¡ï¼Œåˆ†é…è½¦è¾†å’Œå¸æœºï¼Œç®¡ç†ä»»åŠ¡çš„å…¨ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬ä»»åŠ¡åˆ›å»ºã€åˆ†é…ã€çŠ¶æ€æµè½¬ã€ç»Ÿè®¡åˆ†æç­‰åŠŸèƒ½ã€‚

**å®Œæˆæ—¶é—´**: 2026-01-26  
**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ç‰ˆæœ¬**: v1.0.0

---

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### æ ¸å¿ƒåŠŸèƒ½

1. **ä»»åŠ¡ç®¡ç†**
   - âœ… ä»è®¢å•åˆ›å»ºä»»åŠ¡
   - âœ… æŸ¥è¯¢ä»»åŠ¡åˆ—è¡¨ï¼ˆåˆ†é¡µã€ç­›é€‰ã€æ’åºï¼‰
   - âœ… æŸ¥è¯¢å•ä¸ªä»»åŠ¡è¯¦æƒ…
   - âœ… æ›´æ–°ä»»åŠ¡ä¿¡æ¯
   - âœ… åˆ é™¤ä»»åŠ¡ï¼ˆè½¯åˆ é™¤ï¼‰

2. **ä»»åŠ¡åˆ†é…**
   - âœ… åˆ†é…è½¦è¾†å’Œå¸æœº
   - âœ… è‡ªåŠ¨ç”Ÿæˆä»»åŠ¡ç¼–å·
   - âœ… è½¦è¾†çŠ¶æ€ç®¡ç†
   - âœ… å¸æœºçŠ¶æ€ç®¡ç†

3. **ä»»åŠ¡çŠ¶æ€ç®¡ç†**
   - âœ… 7ç§ä»»åŠ¡çŠ¶æ€æµè½¬
   - âœ… çŠ¶æ€éªŒè¯ï¼ˆé˜²æ­¢éæ³•æµè½¬ï¼‰
   - âœ… æ—¶é—´æˆ³è®°å½•ï¼ˆå‡ºå‘ã€åˆ°è¾¾ã€å®Œæˆï¼‰

4. **ä¼˜å…ˆçº§ç®¡ç†**
   - âœ… 4ä¸ªä¼˜å…ˆçº§ï¼ˆä½ã€æ™®é€šã€é«˜ã€ç´§æ€¥ï¼‰
   - âœ… æŒ‰ä¼˜å…ˆçº§æ’åº

5. **æ•°æ®ç»Ÿè®¡**
   - âœ… ä»»åŠ¡æ•°é‡ç»Ÿè®¡
   - âœ… æŒ‰çŠ¶æ€åˆ†ç»„ç»Ÿè®¡
   - âœ… æ€»é…é€æ–¹é‡ç»Ÿè®¡
   - âœ… æŒ‰ç«™ç‚¹å’Œæ—¶é—´èŒƒå›´ç­›é€‰

6. **èµ„æºç®¡ç†**
   - âœ… è½¦è¾†å ç”¨/é‡Šæ”¾
   - âœ… å¸æœºå ç”¨/é‡Šæ”¾
   - âœ… èµ„æºå¯ç”¨æ€§æ£€æŸ¥

---

## ğŸ“‹ ä»»åŠ¡çŠ¶æ€æµè½¬

```
pending (å¾…åˆ†é…)
    â†“
assigned (å·²åˆ†é…)
    â†“
in_transit (è¿è¾“ä¸­)
    â†“
arrived (å·²åˆ°è¾¾)
    â†“
unloading (å¸è´§ä¸­)
    â†“
completed (å·²å®Œæˆ)

ä»»ä½•çŠ¶æ€éƒ½å¯ä»¥ â†’ cancelled (å·²å–æ¶ˆ)
```

### çŠ¶æ€è¯´æ˜

| çŠ¶æ€ | è¯´æ˜ | å…è®¸çš„æ“ä½œ | èµ„æºçŠ¶æ€ |
|------|------|-----------|---------|
| `pending` | å¾…åˆ†é… | å¯åˆ†é…ã€å¯ä¿®æ”¹ã€å¯åˆ é™¤ | æœªå ç”¨ |
| `assigned` | å·²åˆ†é… | å¯å‡ºå‘ã€å¯ä¿®æ”¹ã€å¯å–æ¶ˆ | å·²å ç”¨ |
| `in_transit` | è¿è¾“ä¸­ | å¯åˆ°è¾¾ã€å¯å–æ¶ˆ | å·²å ç”¨ |
| `arrived` | å·²åˆ°è¾¾ | å¯å¼€å§‹å¸è´§ã€å¯å–æ¶ˆ | å·²å ç”¨ |
| `unloading` | å¸è´§ä¸­ | å¯å®Œæˆ | å·²å ç”¨ |
| `completed` | å·²å®Œæˆ | ä¸å¯ä¿®æ”¹ | å·²é‡Šæ”¾ |
| `cancelled` | å·²å–æ¶ˆ | ä¸å¯ä¿®æ”¹ | å·²é‡Šæ”¾ |

---

## ğŸ”Œ API æ¥å£

### åŸºç¡€è·¯å¾„
```
/api/tasks
```

### æ¥å£åˆ—è¡¨

#### 1. åˆ›å»ºä»»åŠ¡
```http
POST /api/tasks
```

**æƒé™**: admin, manager, operator

**è¯·æ±‚ä½“**:
```json
{
  "orderId": 1,
  "vehicleId": 1,
  "driverId": 1,
  "deliveryVolume": 10,
  "deliveryAddress": "åŒ—äº¬å¸‚æœé˜³åŒºxxx",
  "scheduledTime": "2026-02-01T10:00:00Z",
  "priority": "normal",
  "remarks": "å¤‡æ³¨ä¿¡æ¯"
}
```

**å“åº”**:
```json
{
  "id": 1,
  "task_no": "TASK202601260001",
  "order_id": 1,
  "site_id": 1,
  "vehicle_id": 1,
  "driver_id": 1,
  "delivery_volume": 10,
  "delivery_address": "åŒ—äº¬å¸‚æœé˜³åŒºxxx",
  "scheduled_time": "2026-02-01T10:00:00.000Z",
  "priority": "normal",
  "status": "pending",
  "created_at": "2026-01-26T10:00:00.000Z",
  "order": {...},
  "vehicle": {...},
  "driver": {...}
}
```

#### 2. æŸ¥è¯¢ä»»åŠ¡åˆ—è¡¨
```http
GET /api/tasks?page=1&limit=10&status=pending&priority=high
```

**æƒé™**: éœ€è¦ç™»å½•

**æŸ¥è¯¢å‚æ•°**:
- `page`: é¡µç ï¼ˆé»˜è®¤1ï¼‰
- `limit`: æ¯é¡µæ•°é‡ï¼ˆé»˜è®¤10ï¼‰
- `siteId`: ç«™ç‚¹ID
- `taskNo`: ä»»åŠ¡ç¼–å·ï¼ˆæ¨¡ç³Šæœç´¢ï¼‰
- `orderId`: è®¢å•ID
- `vehicleId`: è½¦è¾†ID
- `driverId`: å¸æœºID
- `status`: ä»»åŠ¡çŠ¶æ€
- `priority`: ä¼˜å…ˆçº§
- `startDate`: å¼€å§‹æ—¥æœŸ
- `endDate`: ç»“æŸæ—¥æœŸ
- `sortBy`: æ’åºå­—æ®µï¼ˆé»˜è®¤created_atï¼‰
- `sortOrder`: æ’åºæ–¹å‘ï¼ˆasc/descï¼Œé»˜è®¤descï¼‰

**å“åº”**:
```json
{
  "data": [...],
  "total": 100,
  "page": 1,
  "limit": 10,
  "totalPages": 10
}
```

#### 3. æŸ¥è¯¢å•ä¸ªä»»åŠ¡
```http
GET /api/tasks/:id
```

**æƒé™**: éœ€è¦ç™»å½•

**å“åº”**: åŒ…å«ä»»åŠ¡è¯¦æƒ…ã€è®¢å•ä¿¡æ¯ã€è½¦è¾†ä¿¡æ¯ã€å¸æœºä¿¡æ¯ã€ç”Ÿäº§æ‰¹æ¬¡ç­‰

#### 4. æ›´æ–°ä»»åŠ¡
```http
PATCH /api/tasks/:id
```

**æƒé™**: admin, manager, operator

**è¯·æ±‚ä½“**: ä¸åˆ›å»ºä»»åŠ¡ç±»ä¼¼ï¼Œæ‰€æœ‰å­—æ®µå¯é€‰

#### 5. åˆ†é…ä»»åŠ¡
```http
POST /api/tasks/:id/assign
```

**æƒé™**: admin, manager, operator

**è¯·æ±‚ä½“**:
```json
{
  "vehicleId": 1,
  "driverId": 1,
  "scheduledTime": "2026-02-01T10:00:00Z"
}
```

**åŠŸèƒ½**: ä¸ºå¾…åˆ†é…çš„ä»»åŠ¡åˆ†é…è½¦è¾†å’Œå¸æœº

#### 6. æ›´æ–°ä»»åŠ¡çŠ¶æ€
```http
PATCH /api/tasks/:id/status
```

**æƒé™**: admin, manager, operator, driver

**è¯·æ±‚ä½“**:
```json
{
  "status": "in_transit"
}
```

**æ³¨æ„**: å¸æœºå¯ä»¥æ›´æ–°è‡ªå·±ä»»åŠ¡çš„çŠ¶æ€

#### 7. åˆ é™¤ä»»åŠ¡
```http
DELETE /api/tasks/:id
```

**æƒé™**: admin, manager

**æ³¨æ„**: è¿›è¡Œä¸­çš„ä»»åŠ¡ä¸èƒ½åˆ é™¤

#### 8. è·å–ä»»åŠ¡ç»Ÿè®¡
```http
GET /api/tasks/statistics?siteId=1&startDate=2026-01-01&endDate=2026-01-31
```

**æƒé™**: éœ€è¦ç™»å½•

**å“åº”**:
```json
{
  "totalTasks": 100,
  "statusCount": {
    "pending": 10,
    "assigned": 15,
    "inTransit": 20,
    "arrived": 10,
    "unloading": 5,
    "completed": 35,
    "cancelled": 5
  },
  "totalVolume": 1000
}
```

---

## ğŸ“ æ–‡ä»¶ç»“æ„

```
concrete-plant-api/src/tasks/
â”œâ”€â”€ dto/
â”‚   â”œâ”€â”€ create-task.dto.ts          # åˆ›å»ºä»»åŠ¡DTO
â”‚   â”œâ”€â”€ update-task.dto.ts          # æ›´æ–°ä»»åŠ¡DTO
â”‚   â”œâ”€â”€ query-task.dto.ts           # æŸ¥è¯¢ä»»åŠ¡DTO
â”‚   â”œâ”€â”€ assign-task.dto.ts          # åˆ†é…ä»»åŠ¡DTO
â”‚   â””â”€â”€ update-task-status.dto.ts   # æ›´æ–°çŠ¶æ€DTO
â”œâ”€â”€ tasks.controller.ts             # ä»»åŠ¡æ§åˆ¶å™¨
â”œâ”€â”€ tasks.service.ts                # ä»»åŠ¡æœåŠ¡
â””â”€â”€ tasks.module.ts                 # ä»»åŠ¡æ¨¡å—
```

---

## ğŸ”’ æƒé™æ§åˆ¶

### è§’è‰²æƒé™çŸ©é˜µ

| æ“ä½œ | admin | manager | operator | driver | quality |
|------|-------|---------|----------|--------|---------|
| åˆ›å»ºä»»åŠ¡ | âœ… | âœ… | âœ… | âŒ | âŒ |
| æŸ¥è¯¢ä»»åŠ¡ | âœ… | âœ… | âœ… | âœ… | âœ… |
| æ›´æ–°ä»»åŠ¡ | âœ… | âœ… | âœ… | âŒ | âŒ |
| åˆ†é…ä»»åŠ¡ | âœ… | âœ… | âœ… | âŒ | âŒ |
| æ›´æ–°çŠ¶æ€ | âœ… | âœ… | âœ… | âœ… | âŒ |
| åˆ é™¤ä»»åŠ¡ | âœ… | âœ… | âŒ | âŒ | âŒ |
| æŸ¥çœ‹ç»Ÿè®¡ | âœ… | âœ… | âœ… | âœ… | âœ… |

---

## âœ… æ•°æ®éªŒè¯

### åˆ›å»ºä»»åŠ¡éªŒè¯è§„åˆ™

| å­—æ®µ | ç±»å‹ | å¿…å¡« | éªŒè¯è§„åˆ™ |
|------|------|------|---------|
| orderId | number | âœ… | å¿…é¡»å­˜åœ¨çš„è®¢å•IDï¼Œè®¢å•çŠ¶æ€ä¸ºconfirmedæˆ–in_production |
| vehicleId | number | âŒ | å¦‚æœæä¾›ï¼Œå¿…é¡»å­˜åœ¨ä¸”çŠ¶æ€ä¸ºavailable |
| driverId | number | âŒ | å¦‚æœæä¾›ï¼Œå¿…é¡»å­˜åœ¨ä¸”çŠ¶æ€ä¸ºavailable |
| deliveryVolume | number | âœ… | å¿…é¡»å¤§äº0 |
| deliveryAddress | string | âŒ | é»˜è®¤ä½¿ç”¨è®¢å•çš„æ–½å·¥åœ°å€ |
| scheduledTime | datetime | âŒ | ISO 8601æ ¼å¼ |
| priority | enum | âŒ | low/normal/high/urgentï¼Œé»˜è®¤normal |
| remarks | string | âŒ | - |

### åˆ†é…ä»»åŠ¡éªŒè¯è§„åˆ™

| å­—æ®µ | ç±»å‹ | å¿…å¡« | éªŒè¯è§„åˆ™ |
|------|------|------|---------|
| vehicleId | number | âœ… | å¿…é¡»å­˜åœ¨ä¸”çŠ¶æ€ä¸ºavailable |
| driverId | number | âœ… | å¿…é¡»å­˜åœ¨ä¸”çŠ¶æ€ä¸ºavailable |
| scheduledTime | datetime | âŒ | ISO 8601æ ¼å¼ |

---

## ğŸ”„ ä¸šåŠ¡æµç¨‹

### å…¸å‹ä»»åŠ¡æµç¨‹

```
1. è®¢å•ç¡®è®¤ååˆ›å»ºä»»åŠ¡
   â†“
2. åˆ†é…è½¦è¾†å’Œå¸æœºï¼ˆpending â†’ assignedï¼‰
   â†“
3. å¸æœºå‡ºå‘ï¼ˆassigned â†’ in_transitï¼‰
   è®°å½•å‡ºå‘æ—¶é—´
   â†“
4. åˆ°è¾¾æ–½å·¥ç°åœºï¼ˆin_transit â†’ arrivedï¼‰
   è®°å½•åˆ°è¾¾æ—¶é—´
   â†“
5. å¼€å§‹å¸è´§ï¼ˆarrived â†’ unloadingï¼‰
   â†“
6. å¸è´§å®Œæˆï¼ˆunloading â†’ completedï¼‰
   è®°å½•å®Œæˆæ—¶é—´
   é‡Šæ”¾è½¦è¾†å’Œå¸æœº
```

### èµ„æºç®¡ç†æµç¨‹

```
åˆ›å»º/åˆ†é…ä»»åŠ¡æ—¶:
  - æ£€æŸ¥è½¦è¾†çŠ¶æ€ (available)
  - æ£€æŸ¥å¸æœºçŠ¶æ€ (available)
  - å ç”¨èµ„æº (in_use / on_duty)

ä»»åŠ¡å®Œæˆ/å–æ¶ˆæ—¶:
  - é‡Šæ”¾è½¦è¾† (available)
  - é‡Šæ”¾å¸æœº (available)
```

---

## ğŸ“Š æ•°æ®åº“å…³ç³»

### å…³è”è¡¨

- `tasks` - ä»»åŠ¡ä¸»è¡¨
- `orders` - è®¢å•è¡¨
- `vehicles` - è½¦è¾†è¡¨
- `drivers` - å¸æœºè¡¨
- `sites` - ç«™ç‚¹è¡¨
- `users` - ç”¨æˆ·è¡¨ï¼ˆåˆ›å»ºäººï¼‰
- `production_batches` - ç”Ÿäº§æ‰¹æ¬¡è¡¨

### å¤–é”®å…³ç³»

```sql
tasks.order_id â†’ orders.id
tasks.vehicle_id â†’ vehicles.id
tasks.driver_id â†’ drivers.id
tasks.site_id â†’ sites.id
tasks.created_by â†’ users.id
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### ä¸šåŠ¡è§„åˆ™

1. **è®¢å•çŠ¶æ€é™åˆ¶**: åªèƒ½ä¸ºå·²ç¡®è®¤æˆ–ç”Ÿäº§ä¸­çš„è®¢å•åˆ›å»ºä»»åŠ¡
2. **èµ„æºå¯ç”¨æ€§**: åˆ†é…æ—¶å¿…é¡»æ£€æŸ¥è½¦è¾†å’Œå¸æœºçš„å¯ç”¨æ€§
3. **çŠ¶æ€æµè½¬é™åˆ¶**: å¿…é¡»æŒ‰ç…§è§„å®šçš„çŠ¶æ€æµè½¬è·¯å¾„
4. **åˆ é™¤é™åˆ¶**: è¿›è¡Œä¸­çš„ä»»åŠ¡ä¸èƒ½åˆ é™¤
5. **èµ„æºé‡Šæ”¾**: ä»»åŠ¡å®Œæˆæˆ–å–æ¶ˆæ—¶è‡ªåŠ¨é‡Šæ”¾è½¦è¾†å’Œå¸æœº
6. **ä»»åŠ¡ç¼–å·**: è‡ªåŠ¨ç”Ÿæˆï¼Œæ ¼å¼ä¸º TASK+æ—¥æœŸ+åºå·

### æ€§èƒ½ä¼˜åŒ–

1. **åˆ†é¡µæŸ¥è¯¢**: é»˜è®¤æ¯é¡µ10æ¡ï¼Œå»ºè®®ä¸è¶…è¿‡100æ¡
2. **ç´¢å¼•ä¼˜åŒ–**: ä»»åŠ¡ç¼–å·ã€çŠ¶æ€ã€è®¢å•IDã€è½¦è¾†IDã€å¸æœºIDå·²å»ºç«‹ç´¢å¼•
3. **å…³è”æŸ¥è¯¢**: ä½¿ç”¨ Prisma include ä¼˜åŒ–å…³è”æŸ¥è¯¢
4. **è½¯åˆ é™¤**: ä½¿ç”¨ deleted_at å­—æ®µå®ç°è½¯åˆ é™¤

---

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### çŸ­æœŸä¼˜åŒ–

1. **æ™ºèƒ½è°ƒåº¦**: è‡ªåŠ¨åˆ†é…æœ€ä¼˜è½¦è¾†å’Œå¸æœº
2. **è·¯çº¿è§„åˆ’**: é›†æˆåœ°å›¾APIè¿›è¡Œè·¯çº¿è§„åˆ’
3. **å®æ—¶è¿½è¸ª**: è½¦è¾†GPSå®æ—¶ä½ç½®è¿½è¸ª
4. **ä»»åŠ¡æé†’**: åˆ°è¾¾æ—¶é—´æé†’ã€å»¶è¿Ÿé¢„è­¦

### ä¸­æœŸä¼˜åŒ–

5. **æ‰¹é‡åˆ†é…**: æ”¯æŒæ‰¹é‡åˆ›å»ºå’Œåˆ†é…ä»»åŠ¡
6. **ä»»åŠ¡æ¨¡æ¿**: å¸¸ç”¨ä»»åŠ¡æ¨¡æ¿å¿«é€Ÿåˆ›å»º
7. **è°ƒåº¦ç®—æ³•**: ä¼˜åŒ–è°ƒåº¦ç®—æ³•æé«˜æ•ˆç‡
8. **ç”µå­ç­¾æ”¶**: æ”¯æŒç”µå­ç­¾æ”¶åŠŸèƒ½

### é•¿æœŸä¼˜åŒ–

9. **AIè°ƒåº¦**: æœºå™¨å­¦ä¹ ä¼˜åŒ–è°ƒåº¦å†³ç­–
10. **é¢„æµ‹åˆ†æ**: é…é€æ—¶é—´é¢„æµ‹
11. **ç§»åŠ¨ç«¯**: å¸æœºç§»åŠ¨ç«¯åº”ç”¨
12. **è¯­éŸ³äº¤äº’**: è¯­éŸ³æŠ¥å‘Šä»»åŠ¡çŠ¶æ€

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### å‰ç«¯é›†æˆç¤ºä¾‹

```typescript
// åˆ›å»ºä»»åŠ¡
const createTask = async (taskData) => {
  const response = await fetch('/api/tasks', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`,
    },
    body: JSON.stringify(taskData),
  });
  return response.json();
};

// åˆ†é…ä»»åŠ¡
const assignTask = async (taskId, assignData) => {
  const response = await fetch(`/api/tasks/${taskId}/assign`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`,
    },
    body: JSON.stringify(assignData),
  });
  return response.json();
};

// æ›´æ–°ä»»åŠ¡çŠ¶æ€
const updateTaskStatus = async (taskId, status) => {
  const response = await fetch(`/api/tasks/${taskId}/status`, {
    method: 'PATCH',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`,
    },
    body: JSON.stringify({ status }),
  });
  return response.json();
};

// æŸ¥è¯¢ä»»åŠ¡åˆ—è¡¨
const fetchTasks = async (filters) => {
  const params = new URLSearchParams(filters);
  const response = await fetch(`/api/tasks?${params}`, {
    headers: {
      'Authorization': `Bearer ${token}`,
    },
  });
  return response.json();
};
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
- å®Œæ•´æ–‡æ¡£ï¼š`TASKS_MODULE_README.md`
- æµ‹è¯•è„šæœ¬ï¼š`test-scripts/test-tasks.sh`
- APIæ–‡æ¡£ï¼š`/api/docs`ï¼ˆå¦‚å·²é…ç½®Swaggerï¼‰

---

**æœ€åæ›´æ–°**: 2026-01-26  
**ç‰ˆæœ¬**: v1.0.0  
**çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª
